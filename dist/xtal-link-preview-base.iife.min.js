!function(){const t="disabled";const e="href",s="service-url",r="fetch-in-progress",i="fetch-complete",h="title";class n extends(function(e){return class extends e{constructor(){super(...arguments),this._evCount={}}static get observedAttributes(){return[t]}get disabled(){return this._disabled}set disabled(e){this.attr(t,e,"")}attr(t,e,s){this[(e?"set":"remove")+"Attribute"](t,s||e)}to$(t){const e=t%2;return(t-e)/2+"-"+e}incAttr(t){const e=this._evCount;t in e?e[t]++:e[t]=0,this.attr("data-"+t,this.to$(e[t]))}attributeChangedCallback(e,s,r){switch(e){case t:this._disabled=null!==r}}de(t,e,s=!1){const r=t+(s?"":"-changed"),i=new CustomEvent(r,{detail:e,bubbles:!0,composed:!1});return this.dispatchEvent(i),this.incAttr(r),i}_upgradeProperties(t){t.forEach(t=>{if(this.hasOwnProperty(t)){let e=this[t];delete this[t],this[t]=e}})}}}(HTMLElement)){constructor(){super(...arguments),this._serviceUrl="https://cors-anywhere.herokuapp.com/",this._connected=!1}get serviceUrl(){return this._serviceUrl}set serviceUrl(t){this.attr("service-url",t)}get href(){return this._href}set href(t){this.attr("href",t)}get fetchInProgress(){return this._fetchInProgress}set fetchInProgress(t){this._fetchInProgress=t,this.attr(r,t,""),this.de(r,{value:t})}get fetchComplete(){return this._fetchComplete}set fetchComplete(t){this._fetchComplete=t,this.attr(i,t,""),this.de(i,{value:t})}get title(){return this._title}set title(t){this._title=t,this.attr(h,t)}static get observedAttributes(){return super.observedAttributes.concat([e,s])}attributeChangedCallback(t,e,s){switch(super.attributeChangedCallback(t,e,s),t){case"href":this._href=s;break;case"service-url":this._serviceUrl=s}this.onPropsChange()}connectedCallback(){this._upgradeProperties(["disabled",e,"serviceUrl"]),this._connected=!0,this.de("connected",{value:this.href}),this.onPropsChange()}set abort(t){this._controller&&this._controller.abort()}doFetch(){const t=this.calculateURL();if(this._previousURL===t)return this.fetchComplete=!1,void(this.fetchComplete=!0);this._previousURL=t,this.title="Loading...",this.fetchInProgress=!0,this.fetchComplete=!1;let e=null;AbortController&&(this._controller=new AbortController,e=this._controller.signal),fetch(t,{signal:e}).then(t=>{this.fetchInProgress=!1,this.processResponse(t),this.fetchComplete=!0}).catch(t=>{"AbortError"===t.name&&(console.log("Fetch aborted"),delete this._previousURL)})}calculateURL(t=0){let e=this._href;if(t){const s=e.split("/");-1===t&&(e=[s[0],s[1],s[2]].join("/"))}return this._serviceUrl+e}}const c="preview",l="image-width";!function(t){let e=t.is;customElements.get(e)?console.warn("Already registered "+e):customElements.define(e,t)}(class extends n{constructor(){super(),this._serviceUrl="https://cors-anywhere.herokuapp.com/",this._preview=!1,this._imageWidth=150,this.style.display="block"}static get is(){return"xtal-link-preview-base"}get preview(){return this._preview}set preview(t){this.attr(c,t,"")}get imageWidth(){return this._imageWidth}set imageWidth(t){this.attr(l,t.toString())}static get observedAttributes(){return super.observedAttributes.concat([c,l])}connectedCallback(){this._upgradeProperties([c,"imageWidth"]),super.connectedCallback()}calculateURL(){return this._serviceUrl+this._href}onPropsChange(){this._connected&&this._preview&&!this.disabled&&this._href&&this._serviceUrl&&this.doFetch()}getMetaContent(t,e,s){let r=function(t,e){return[].slice.call((e||this).querySelectorAll(t))}("meta["+e+'="'+s+'"]',t).filter(t=>t.content);return r&&r.length>0?r[0].content:null}getAbsPath(t){let e=t,s=this._href;const r=s.indexOf("#");if(r>-1&&(s=s.substr(0,r)),!t.startsWith("http")&&!t.startsWith("data"))if(t.startsWith("/"))e=s.split("/").slice(0,3).join("/")+t;else{const r=s.endsWith("/")?"":"/";e.startsWith("/")&&e.replace("/",""),e=s+r+t}return e}processResponse(t){t.text().then(t=>{this.fetchInProgress=!1;const e=(new DOMParser).parseFromString(t,"text/html");let s=this.getMetaContent(e,"name","twitter:image:src");if(s||(s=this.getMetaContent(e,"name","twitter:image")),s||(s=this.getMetaContent(e,"property","og:image")),!s){const t=e.querySelector("img");t&&(s=t.getAttribute("src"))}if(!s){const t=e.querySelector('link[rel="icon"]');t&&(s=t.getAttribute("href"))}s&&(s=this.getAbsPath(s));let r=e.querySelector("title");r&&(this.title=r.innerHTML);let i=this.getMetaContent(e,"name","description");i?this.title=this.title.replace(i,""):i="",this.setInnerHTML(`\n                <div>\n                    <details open>\n                        <summary>${this.title}</summary>\n                        <p>${i}</p>\n                    </details>\n                    <img alt="${this.title}" width="${this._imageWidth}" src="${s}"/>\n                </div>\n            `),this.fetchComplete=!0})}setInnerHTML(t){this.innerHTML=t}attributeChangedCallback(t,e,s){switch(t){case"preview":this._preview=null!==s,this._preview||(this.abort=!0)}super.attributeChangedCallback(t,e,s)}})}();